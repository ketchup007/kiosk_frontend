{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="top-section">
        <img src="{{ url_for('static', filename='images/MunchiesLogoPlain.svg') }}" alt="Munchies Logo" class="logo">
        <div class="language-selector">
            <button onclick="changeLanguage('pl')">
                <img src="{{ url_for('static', filename='images/plFlag.png') }}" alt="PL">
            </button>
            <button onclick="changeLanguage('en')">
                <img src="{{ url_for('static', filename='images/angFlag.png') }}" alt="EN">
            </button>
            <button onclick="changeLanguage('uk')">
                <img src="{{ url_for('static', filename='images/uaFlag.png') }}" alt="UK">
            </button>
        </div>
        <p class="estimated-time">{{ _('Estimated waiting time: %(time)d min', time=estimated_waiting_time) }}</p>
    </div>
    <div class="middle-section">
        <div class="category-bar">
            {% for category in ['snack', 'drink', 'coffee', 'take_away_box', 'sauce', 'sum'] %}
                <button class="category-button" data-category="{{ category }}">{{ _(category) }}</button>
            {% endfor %}
        </div>
        <div class="product-list">
            {% for item in menu %}
                <div class="product-item" data-category="{{ item.category }}">
                    <img src="{{ item.image }}" alt="{{ item.name }}" class="product-image">
                    <h3>{{ item.name }}</h3>
                    <p>{{ item.description }}</p>
                    <p>{{ _('Price: %(price).2f', price=item.price) }}</p>
                    <div class="quantity-control">
                        <button class="decrease-quantity" data-item-id="{{ item.id }}">-</button>
                        <span class="quantity" data-item-id="{{ item.id }}">0</span>
                        <button class="increase-quantity" data-item-id="{{ item.id }}">+</button>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    <div class="bottom-section">
        <button id="cancel-order" class="action-button">{{ _('Cancel') }}</button>
        <button id="proceed-to-summary" class="action-button">{{ _('Total: %(total).2f', total=0.00) }}</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let total = 0;
    const orderItems = {};

    function updateTotal() {
        const totalElement = document.getElementById('proceed-to-summary');
        totalElement.textContent = '{{ _("Total: %(total).2f", total=0.00) }}'.replace('0.00', total.toFixed(2));
    }

    function updateQuantity(itemId, change) {
        const quantityElement = document.querySelector(`.quantity[data-item-id="${itemId}"]`);
        let quantity = parseInt(quantityElement.textContent) + change;
        quantity = Math.max(0, quantity);
        quantityElement.textContent = quantity;

        if (quantity > 0) {
            if (!orderItems[itemId]) {
                orderItems[itemId] = {
                    quantity: 0,
                    price: parseFloat(document.querySelector(`.product-item[data-item-id="${itemId}"] .price`).textContent)
                };
            }
            orderItems[itemId].quantity = quantity;
        } else {
            delete orderItems[itemId];
        }

        total = Object.values(orderItems).reduce((sum, item) => sum + item.quantity * item.price, 0);
        updateTotal();

        // Send update to server
        fetch('/add_to_order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                order_id: {{ order_id }},
                item_id: itemId,
                quantity: change
            })
        }).then(response => response.json())
          .then(data => {
              if (!data.success) {
                  alert('{{ _("Failed to update order. Please try again.") }}');
              }
          });
    }

    document.querySelectorAll('.increase-quantity').forEach(button => {
        button.addEventListener('click', function() {
            updateQuantity(this.dataset.itemId, 1);
        });
    });

    document.querySelectorAll('.decrease-quantity').forEach(button => {
        button.addEventListener('click', function() {
            updateQuantity(this.dataset.itemId, -1);
        });
    });

    document.querySelectorAll('.category-button').forEach(button => {
        button.addEventListener('click', function() {
            const category = this.dataset.category;
            document.querySelectorAll('.product-item').forEach(item => {
                if (category === 'sum' || item.dataset.category === category) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    });

    document.getElementById('cancel-order').addEventListener('click', function() {
        if (confirm('{{ _("Are you sure you want to cancel your order?") }}')) {
            fetch('/cancel_order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    order_id: {{ order_id }}
                })
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      window.location.href = '/';
                  } else {
                      alert('{{ _("Failed to cancel order. Please try again.") }}');
                  }
              });
        }
    });

    document.getElementById('proceed-to-summary').addEventListener('click', function() {
        if (total > 0) {
            window.location.href = `/order/summary/{{ order_id }}`;
        } else {
            alert('{{ _("Please add items to your order before proceeding.") }}');
        }
    });

    // Check item availability every second
    setInterval(function() {
        fetch('/get_available_items?order_id={{ order_id }}')
            .then(response => response.json())
            .then(data => {
                data.available_items.forEach(item => {
                    const quantityElement = document.querySelector(`.quantity[data-item-id="${item.id}"]`);
                    const increaseButton = document.querySelector(`.increase-quantity[data-item-id="${item.id}"]`);
                    if (item.available_quantity > 0) {
                        increaseButton.disabled = false;
                    } else {
                        increaseButton.disabled = true;
                        if (parseInt(quantityElement.textContent) > 0) {
                            updateQuantity(item.id, -parseInt(quantityElement.textContent));
                        }
                    }
                });
            });
    }, 1000);

    // Inactivity detection
    let inactivityTimer;
    function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(function() {
            if (confirm('{{ _("You have been inactive for a while. Do you want to continue your order?") }}')) {
                resetInactivityTimer();
            } else {
                fetch('/cancel_order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        order_id: {{ order_id }}
                    })
                }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          window.location.href = '/';
                      } else {
                          alert('{{ _("Failed to cancel order. Please try again.") }}');
                      }
                  });
            }
        }, 600000); // 10 minutes
    }
    document.addEventListener('touchstart', resetInactivityTimer);
    resetInactivityTimer();
});
</script>
{% endblock %}
