{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="top-section">
        <img src="{{ url_for('static', filename='images/MunchiesLogoPlain.svg') }}" alt="Munchies Logo" class="logo">
        <div class="language-selector">
            <button onclick="changeLanguage('pl')">
                <img src="{{ url_for('static', filename='images/plFlag.png') }}" alt="PL">
            </button>
            <button onclick="changeLanguage('en')">
                <img src="{{ url_for('static', filename='images/angFlag.png') }}" alt="EN">
            </button>
            <button onclick="changeLanguage('uk')">
                <img src="{{ url_for('static', filename='images/uaFlag.png') }}" alt="UK">
            </button>
        </div>
    </div>
    <div class="middle-section">
        <h2>{{ _('Order Summary') }}</h2>
        <div class="order-items">
            {% for item in order_details.items %}
                <div class="order-item">
                    <span>{{ item.name }}</span>
                    <div class="quantity-control">
                        <button class="decrease-quantity" data-item-id="{{ item.id }}">-</button>
                        <span class="quantity" data-item-id="{{ item.id }}">{{ item.quantity }}</span>
                        <button class="increase-quantity" data-item-id="{{ item.id }}">+</button>
                    </div>
                    <span>{{ _('Price: %(price).2f', price=item.price * item.quantity) }}</span>
                </div>
            {% endfor %}
        </div>
        <div class="suggested-products">
            <h3>{{ _('Suggested Products') }}</h3>
            {% for product in suggested_products %}
                <div class="suggested-product">
                    <img src="{{ product.image }}" alt="{{ product.name }}" class="product-image">
                    <span>{{ product.name }}</span>
                    <span>{{ _('Price: %(price).2f', price=product.price) }}</span>
                    <button class="add-suggested-product" data-item-id="{{ product.id }}">+</button>
                </div>
            {% endfor %}
        </div>
    </div>
    <div class="bottom-section">
        <div class="total">
            <span>{{ _('Total:') }}</span>
            <span id="total-price">{{ _('%(total).2f', total=order_details.total) }}</span>
        </div>
        <button id="cancel-order" class="action-button">{{ _('Cancel Order') }}</button>
        <button id="proceed-to-payment" class="action-button">{{ _('Proceed to Payment') }}</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const updateQuantity = (itemId, change) => {
        const quantityElement = document.querySelector(`.quantity[data-item-id="${itemId}"]`);
        const quantity = Math.max(0, parseInt(quantityElement.textContent) + change);
        
        fetch('/update_order_item', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ order_id: {{ order_id }}, item_id: itemId, quantity })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                quantityElement.textContent = quantity;
                updateTotal();
            } else {
                alert('{{ _("Failed to update order. Please try again.") }}');
            }
        });
    };

    const updateTotal = () => {
        fetch(`/get_order_summary?order_id={{ order_id }}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-price').textContent = 
                    '{{ _("%(total).2f", total=0.00) }}'.replace('0.00', data.summary.total.toFixed(2));
            });
    };

    document.querySelectorAll('.increase-quantity, .decrease-quantity').forEach(button => {
        button.addEventListener('click', () => 
            updateQuantity(button.dataset.itemId, button.classList.contains('increase-quantity') ? 1 : -1));
    });

    document.querySelectorAll('.add-suggested-product').forEach(button => {
        button.addEventListener('click', () => {
            fetch('/add_suggested_product', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    order_id: {{ order_id }}, 
                    item_id: button.dataset.itemId 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('{{ _("Failed to add product. Please try again.") }}');
                }
            });
        });
    });

    let inactivityTimer;
    const resetInactivityTimer = () => {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => {
            if (confirm('{{ _("You have been inactive for a while. Do you want to continue your order?") }}')) {
                resetInactivityTimer();
            } else {
                fetch('/cancel_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: {{ order_id }} })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/';
                    } else {
                        alert('{{ _("Failed to cancel order. Please try again.") }}');
                    }
                });
            }
        }, 1800000);
    };

    document.addEventListener('touchstart', resetInactivityTimer);
    resetInactivityTimer();

    document.getElementById('cancel-order').addEventListener('click', () => {
        if (confirm('{{ _("Are you sure you want to cancel your order?") }}')) {
            fetch('/cancel_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order_id: {{ order_id }} })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '/';
                } else {
                    alert('{{ _("Failed to cancel order. Please try again.") }}');
                }
            });
        }
    });

    document.getElementById('proceed-to-payment').addEventListener('click', () => {
        window.location.href = `/payment/{{ order_id }}`;
    });
});
</script>
{% endblock %}
